pool:
  name: pool-ubuntu-2004

steps:
  - task: GoTool@0
    inputs:
      version: '1.24.1'

  - task: AzureCLI@2
    displayName: Acc Tests with ADO OIDC token
    inputs:
      azureSubscription: $(CONNECTION_ID)
      scriptType: bash
      scriptLocation: "inlineScript"
      addSpnToEnvironment: true
      inlineScript: |
        set -e

        export TF_ACC=1
        export ARM_TENANT_ID=$tenantId
        export ARM_CLIENT_ID=$servicePrincipalId
        export ARM_OIDC_TOKEN=$idToken
        export ARM_USE_OIDC=true
        export ARM_USE_CLI=false

        cd azuredevops/internal/acceptancetests
        go test -run=" TestAccProviderAuth_oidc" .

  - task: AzureCLI@2
    displayName: Acc Tests with ADO OIDC request
    inputs:
      azureSubscription: $(CONNECTION_ID)
      scriptType: bash
      scriptLocation: "inlineScript"
      addSpnToEnvironment: true
      inlineScript: |
        set -e

        export TF_ACC=1
        export ARM_TENANT_ID=$tenantId
        export ARM_CLIENT_ID=$servicePrincipalId
        export ARM_OIDC_REQUEST_TOKEN=$(AccessToken)
        # AZURESUBSCRIPTION_SERVICE_CONNECTION_ID is auto populated in ADO
        export ARM_USE_OIDC=true
        export ARM_USE_CLI=false

        cd azuredevops/internal/acceptancetests
        go test -run=" TestAccProviderAuth_oidc" .
